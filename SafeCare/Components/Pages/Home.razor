@page "/"
@using SafeCare.Components.Form
@using System.ComponentModel.DataAnnotations
@using SafeCare.Dtos
@using SafeCare.Enums
@using SafeCare.Exceptions
@using SafeCare.Services
@using SafeCare.Utils
@using SafeCare.Validators
@using SafeCare.ViewModels
@using SafeCare.Mappings
@inject IIncidentDefinitionService IncidentDefinitionService
@inject IDepartmentService DepartmentService
@inject IIncidentReportService IncidentReportService
@inject ITimezoneService TimezoneService
@inject ISnackbar Snackbar
@inject IScrollManager ScrollManager
@inject ILogger<Home> Logger
@inject IRateLimitService RateLimitService

<PageTitle>Zg³oszenie zdarzenia</PageTitle>

<MudForm @ref="form" Model="@model" Validation="@(validator.ValidateValue)">
    <MudStack Spacing="5">
        <FormHeader />
        <FormCard Title="Dane osoby zg³aszaj¹cej" Number="1">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.Name" Label="Imiê" For="@(() => model.Name)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.Surname" Label="Nazwisko" For="@(() => model.Surname)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.Phone" Label="Nr telefonu" InputType="InputType.Telephone" InputMode="InputMode.tel" For="@(() => model.Phone)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.Email" Label="Adres e-mail" InputType="InputType.Email" InputMode="InputMode.email" For="@(() => model.Email)" />
                </MudItem>
            </MudGrid>
        </FormCard>
        <FormCard Title="Dane osoby której dotyczy zg³oszenie" Number="2">
            <MudGrid>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.PatientName" Label="Imiê" For="@(() => model.PatientName)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.PatientSurname" Label="Nazwisko" For="@(() => model.PatientSurname)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.PatientDob" Format="yyyy-MM-dd" Label="Data urodzenia" InputType="InputType.Date" Clearable For="@(() => model.PatientDob)" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="model.PatientGender" Label="P³eæ" For="@(() => model.PatientGender)" Clearable>
                        <MudSelectItem T="Gender ?" Value="Gender.Female">@Gender.Female.GetDisplayName()</MudSelectItem>
                        <MudSelectItem T="Gender ?" Value="Gender.Male">@Gender.Male.GetDisplayName()</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </FormCard>
        <FormCard Title="Czas i miejsce zdarzenia" Number="3">
            <MudGrid>
                <MudItem xs="12" Class="d-flex justify-start">
                    <MudSwitch @bind-Value="model.IsDatePeriod" @bind-Value:after="HandleIsDatePeriodChanged" Label="Przedzia³ czasu" Color="Color.Primary" />
                </MudItem>

                @if (model.IsDatePeriod)
                {
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="model.DateFrom" Format="yyyy-MM-dd" Label="Od" InputType="InputType.Date" For="@(() => model.DateFrom)" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="model.DateTo" Format="yyyy-MM-dd" Label="Do" InputType="InputType.Date" For="@(() => model.DateTo)" />
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="model.Date" Format="yyyy-MM-dd" Label="Data" InputType="InputType.Date" For="@(() => model.Date)" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="model.Time" Label="Czas" InputType="InputType.Time" For="@(() => model.Time)" />
                    </MudItem>
                }

                <MudItem xs="12">
                    <MudAutocomplete @bind-Value="model.Department" Label="Miejsce zdarzenia" SearchFunc="SearchDepartment" MaxItems="100" For="@(() => model.Department)" />
                </MudItem>
            </MudGrid>
        </FormCard>
        <FormCard Title="Rodzaj zdarzenia" Number="4">
            <MudStack>
                <MudExpansionPanels MultiExpansion="true" @ref="expansionPanels">
                    @foreach (var category in categories.Where(x => x != IncidentCategory.Other))
                    {
                        <MudExpansionPanel Text="@category.GetDisplayName()">
                            <MudStack>
                                @foreach (var incident in incidentDefinitions.Where(x => x.Category == category))
                                {
                                    <MudCheckBox T="bool"
                                                 Label="@incident.Name"
                                                 Color="Color.Primary"
                                                 Value="@model.SelectedIncidentDefinitions.Contains(incident)"
                                                 ValueChanged="(isChecked)=>HandleIncidentChecked(isChecked, incident)" />
                                }
                            </MudStack>
                        </MudExpansionPanel>
                    }
                    <MudExpansionPanel Text="@IncidentCategory.Other.GetDisplayName()">
                        <MudTextField Label="Krótki opis" @bind-Value="model.OtherIncidentDefinition" />
                    </MudExpansionPanel>
                </MudExpansionPanels>
                @if (!string.IsNullOrEmpty(incidentDefinitionsError))
                {
                    <MudText Color="Color.Error" Typo="Typo.caption">@incidentDefinitionsError</MudText>
                }
            </MudStack>
        </FormCard>
        <FormCard Title="Dok³adny opis zdarzenia" Number="5">
            <MudTextField @bind-Value="model.IncidentDescription" Lines="5" AutoGrow MaxLength="5000" For="@(() => model.IncidentDescription)" />
        </FormCard>
        @* Invisible honeypot fields for bot detection *@
        <HoneypotFields @ref="_honeypotFields" />
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Submit" Class="align-self-center px-15">Wyœlij</MudButton>
    </MudStack>
</MudForm>

@code {
    [CascadingParameter]
    private MainLayout MainLayout { get; set; } = default!;

    private IncidentRegistrationFormVm model = new();
    private MudForm? form;
    private IncidentRegistrationFormValidator validator = new();
    private IList<IncidentDefinitionDto> incidentDefinitions = [];
    private IList<DepartmentDto> departments = [];
    private IList<IncidentCategory> categories = Enum.GetValues<IncidentCategory>();
    private string? incidentDefinitionsError;
    private MudExpansionPanels? expansionPanels;
    private string _circuitId = Guid.NewGuid().ToString();
    private HoneypotFields? _honeypotFields;

    protected override async Task OnInitializedAsync()
    {
        MainLayout.SetPath("/");
        incidentDefinitions = await IncidentDefinitionService.GetAll();
    }

    private async Task<IEnumerable<DepartmentDto?>> SearchDepartment(string search, CancellationToken cancellationToken)
    {
        if (departments == null || !departments.Any())
        {
            departments = await DepartmentService.GetAll();
        }

        if (string.IsNullOrEmpty(search))
        {
            return departments;
        }

        return departments.Where(d => d.Name.Contains(search, StringComparison.OrdinalIgnoreCase));
    }

    private void HandleIncidentChecked(bool isChecked, IncidentDefinitionDto incident)
    {
        if (isChecked)
        {
            model.SelectedIncidentDefinitions.Add(incident);
        }
        else
        {
            model.SelectedIncidentDefinitions.Remove(incident);
        }

        incidentDefinitionsError = null;
    }

    private async Task Submit()
    {
        // Check rate limit before processing
        if (!RateLimitService.IsAllowed(_circuitId, "FormSubmission"))
        {
            var timeRemaining = RateLimitService.GetTimeUntilReset(_circuitId, "FormSubmission");
            var seconds = timeRemaining?.TotalSeconds ?? 60;
            Logger.LogWarning("Rate limit exceeded for circuit {CircuitId}", _circuitId);
            Snackbar.Add($"Zbyt wiele zg³oszeñ. Spróbuj ponownie za {seconds:F0} sekund.", Severity.Warning);
            return;
        }

        // Bot detection using honeypot fields
        if (_honeypotFields is null || !_honeypotFields.Validate())
        {
            Logger.LogWarning("Bot detected for circuit {CircuitId}", _circuitId);
            // Silent fail - don't give feedback to bots
            return;
        }

        await form!.Validate();

        var incidentErrors = await validator.ValidateValue(model, nameof(model.SelectedIncidentDefinitions));
        if (incidentErrors.Any())
        {
            incidentDefinitionsError = incidentErrors.FirstOrDefault();
        }

        if (form.IsValid)
        {
            try
            {
                var dto = await model.ToDtoAsync(TimezoneService);
                var reportId = await IncidentReportService.CreateReport(dto);
                Logger.LogInformation("Incident report submitted successfully with Id {ReportId}.", reportId);

                Snackbar.Add("Zg³oszenie zosta³o wys³ane, dziêkujemy.", Severity.Success);
                model = new();
                incidentDefinitionsError = null;
                _honeypotFields?.Reset();
                await expansionPanels!.CollapseAllAsync();
                await form.ResetAsync();
                await ScrollManager.ScrollToTopAsync(null);
            }
            catch (DomainException dex)
            {
                Logger.LogWarning(dex, "A domain error occurred while submitting the incident report: {Message}", dex.Message);
                Snackbar.Add($"Wyst¹pi³ b³¹d podczas wysy³ania zg³oszenia: {dex.Message}", Severity.Error);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "An unexpected error occurred while submitting the incident report.");
                Snackbar.Add($"Wyst¹pi³ b³¹d podczas wysy³ania zg³oszenia.", Severity.Error);
            }
        }
    }

    private void HandleIsDatePeriodChanged()
    {
        if (model.IsDatePeriod)
        {
            model.Date = null;
            model.Time = null;
        }
        else
        {
            model.DateFrom = null;
            model.DateTo = null;
        }
    }
}
