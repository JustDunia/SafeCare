@using Microsoft.AspNetCore.Authorization
@using SafeCare.Enums
@using SafeCare.Services
@using SafeCare.ViewModels
@using System.Threading.Tasks
@using Serilog
@using SafeCare.Utils;
@inject IIncidentReportService IncidentReportService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

@page "/dashboard"
@attribute [Authorize]

<div>
    <MudGrid Class="pt-7 pb-4 ps-6 gap-4">
        <MudTextField Label="Zgłaszający" @bind-Value="request.Filter.FullName" Clearable OnKeyDown="HandleFilterInputKeyDown" Immediate="true" OnClearButtonClick="Reload" Class="text-filter" />
        <MudTextField Label="Pacjent" @bind-Value="request.Filter.PatientFullName" Clearable OnKeyDown="HandleFilterInputKeyDown" Immediate="true" OnClearButtonClick="Reload" Class="text-filter" />
        <MudSelect @bind-Value="request.Filter.Gender" Label="Płeć" Clearable @bind-Value:after="Reload" Style="width:130px">
            <MudSelectItem T="Gender ?" Value="Gender.Female">@Gender.Female.GetDisplayName()</MudSelectItem>
            <MudSelectItem T="Gender ?" Value="Gender.Male">@Gender.Male.GetDisplayName()</MudSelectItem>
            <MudSelectItem T="Gender ?" Value="Gender.NotProvided">Nie podano</MudSelectItem>
        </MudSelect>
        <MudTextField Label="Oddział" @bind-Value="request.Filter.Department" Clearable OnKeyDown="HandleFilterInputKeyDown" Immediate="true" OnClearButtonClick="Reload" Class="text-filter" />
        <MudSelect T="IncidentCategory ?" @bind-Value="selectedCategory" @bind-SelectedValues="request.Filter.Categories" Label="Kategorie" Clearable MultiSelection ToStringFunc="x => x?.GetDisplayName()" @bind-SelectedValues:after="Reload" Style="width:250px">
            @foreach (IncidentCategory? category in Enum.GetValues<IncidentCategory>())
            {
                <MudSelectItem T="IncidentCategory ?" Value="category">@category?.GetDisplayName()</MudSelectItem>
            }
        </MudSelect>
        <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Error" OnClick="ClearFilters" title="Wyczyść filtry" />
    </MudGrid>
    <MudDataGrid T="IncidentReportsGridItem" ServerData="LoadData" Height="calc(100vh - 200px)" FixedHeader Striped Bordered Dense SortMode="SortMode.Single" Elevation="4" ShowColumnOptions="false" @ref="grid" CurrentPage="currentPage" RowsPerPage="currentPageSize" SortDefinitions="gridSortDefinitions">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Lp." StickyLeft HeaderStyle="width: 80px;" />
            <PropertyColumn Property="x => x.FullName" Title="Zgłaszający" HeaderStyle="width: 200px;" />
            <PropertyColumn Property="x => x.PatientFullName" Title="Pacjent" HeaderStyle="width: 200px;" />
            <PropertyColumn Property="x => x.PatientAge" Title="Wiek" HeaderStyle="width: 80px;" />
            <PropertyColumn Property="x => x.PatientGender" Title="Płeć" HeaderStyle="width: 110px;" />
            <TemplateColumn Title="Data zdarzenia" SortBy="x => x.Date" Sortable="true" HeaderStyle="width: 170px;">
                <CellTemplate>
                    @if (context.Item.Date.HasValue)
                    {
                        @context.Item.Date.Value.ToString("dd.MM.yyyy HH:mm")
                    }
                    else if (context.Item.DateFrom.HasValue && context.Item.DateTo.HasValue)
                    {
                        <p>@context.Item.DateFrom.Value.ToString("dd.MM.yyyy")</p>
                        <span> - </span>
                        <p>@context.Item.DateTo.Value.ToString("dd.MM.yyyy")</p>
                    }
                </CellTemplate>
            </TemplateColumn>
            <PropertyColumn Property="x => x.Department" Title="Oddział" />
            <TemplateColumn Title="Kategorie" HeaderStyle="width: 180px;">
                <CellTemplate>
                    @foreach (var item in context.Item.Categories)
                    {
                        <MudChip Color="GetChipColor(item)">@GetChipLabel(item)</MudChip>
                    }
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <PagerContent>
            <MudDataGridPager RowsPerPageString="Ilość wierszy na stronę" InfoFormat="{first_item}-{last_item} z {all_items}" />
        </PagerContent>
    </MudDataGrid>
</div>

@code {
    [CascadingParameter]
    private MainLayout MainLayout { get; set; } = default!;

    [SupplyParameterFromQuery(Name = "fullName")]
    public string? FullNameQuery { get; set; }

    [SupplyParameterFromQuery(Name = "patientFullName")]
    public string? PatientFullNameQuery { get; set; }

    [SupplyParameterFromQuery(Name = "gender")]
    public string? GenderQuery { get; set; }

    [SupplyParameterFromQuery(Name = "department")]
    public string? DepartmentQuery { get; set; }

    [SupplyParameterFromQuery(Name = "categories")]
    public string? CategoriesQuery { get; set; }

    [SupplyParameterFromQuery(Name = "page")]
    public int? PageQuery { get; set; }

    [SupplyParameterFromQuery(Name = "pageSize")]
    public int? PageSizeQuery { get; set; }

    [SupplyParameterFromQuery(Name = "sortBy")]
    public string? SortByQuery { get; set; }

    [SupplyParameterFromQuery(Name = "sortDesc")]
    public bool? SortDescQuery { get; set; }

    private IncidentReportsRequestVm request = new();
    private MudDataGrid<IncidentReportsGridItem> grid = new();
    private IncidentCategory? selectedCategory = null;
    private int currentPage = IncidentReportsRequestVm.DefaultPage;
    private int currentPageSize = IncidentReportsRequestVm.DefaultPageSize;
    private string? currentSortBy = IncidentReportsRequestVm.DefaultSortBy;
    private bool currentSortDescending = IncidentReportsRequestVm.DefaultSortDescending;
    private Dictionary<string, SortDefinition<IncidentReportsGridItem>> gridSortDefinitions = new();

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        InitializeFiltersFromQuery();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        MainLayout.SetPath("/dashboard");
    }

    private void InitializeFiltersFromQuery()
    {
        request.Filter.FullName = FullNameQuery;
        request.Filter.PatientFullName = PatientFullNameQuery;
        request.Filter.Department = DepartmentQuery;

        if (!string.IsNullOrEmpty(GenderQuery) && Enum.TryParse<Gender>(GenderQuery, out var gender))
        {
            request.Filter.Gender = gender;
        }

        if (!string.IsNullOrEmpty(CategoriesQuery))
        {
            var categoryNames = CategoriesQuery.Split(',', StringSplitOptions.RemoveEmptyEntries);
            var categories = categoryNames
                .Select(name => Enum.TryParse<IncidentCategory>(name, out var cat) ? (IncidentCategory?)cat : null)
                .Where(c => c.HasValue)
                .ToList();
            request.Filter.Categories = categories;
        }

        currentPage = PageQuery ?? IncidentReportsRequestVm.DefaultPage;
            currentPageSize = PageSizeQuery ?? IncidentReportsRequestVm.DefaultPageSize;

            if (!string.IsNullOrEmpty(SortByQuery))
            {
                currentSortBy = SortByQuery;
                currentSortDescending = SortDescQuery ?? false;
            }

            if (!string.IsNullOrEmpty(currentSortBy))
            {
                gridSortDefinitions = new Dictionary<string, SortDefinition<IncidentReportsGridItem>>
                {
                    { currentSortBy, new SortDefinition<IncidentReportsGridItem>(currentSortBy, currentSortDescending, 0, null!) }
                };
            }
        }

    private void UpdateQueryParameters()
    {
        var queryParams = new Dictionary<string, object?>();

        if (!string.IsNullOrEmpty(request.Filter.FullName))
            queryParams["fullName"] = request.Filter.FullName;

        if (!string.IsNullOrEmpty(request.Filter.PatientFullName))
            queryParams["patientFullName"] = request.Filter.PatientFullName;

        if (request.Filter.Gender.HasValue)
            queryParams["gender"] = request.Filter.Gender.Value.ToString();

        if (!string.IsNullOrEmpty(request.Filter.Department))
            queryParams["department"] = request.Filter.Department;

        if (request.Filter.Categories?.Any() == true)
        {
            var categoryNames = request.Filter.Categories
                .Where(c => c.HasValue)
                .Select(c => c!.Value.ToString());
            queryParams["categories"] = string.Join(",", categoryNames);
        }

        if (currentPage > IncidentReportsRequestVm.DefaultPage)
                queryParams["page"] = currentPage;

            if (currentPageSize != IncidentReportsRequestVm.DefaultPageSize)
                queryParams["pageSize"] = currentPageSize;

            var isDefaultSort = currentSortBy == IncidentReportsRequestVm.DefaultSortBy 
                && currentSortDescending == IncidentReportsRequestVm.DefaultSortDescending;
    
            if (!isDefaultSort && !string.IsNullOrEmpty(currentSortBy))
            {
                queryParams["sortBy"] = currentSortBy;
                if (currentSortDescending)
                    queryParams["sortDesc"] = true;
            }

                var uri = NavigationManager.GetUriWithQueryParameters("/dashboard", queryParams);
                NavigationManager.NavigateTo(uri, replace: true);
        }

    private async Task HandleFilterInputKeyDown(KeyboardEventArgs args)
    {
        Console.WriteLine(args.Key);
        if (args.Key != "Enter")
        {
            return;
        }

        await Reload();
    }

    private async Task Reload()
    {
        UpdateQueryParameters();
        await grid.ReloadServerData();
    }

    private async Task ClearFilters()
    {
        request.Filter = new();
        currentPage = IncidentReportsRequestVm.DefaultPage;
        await Reload();
    }

    private async Task<GridData<IncidentReportsGridItem>> LoadData(GridState<IncidentReportsGridItem> state)
    {
        request.Page = state.Page;
        request.PageSize = state.PageSize;
        request.SortDefinitions = state.SortDefinitions;

        var newSortBy = state.SortDefinitions.FirstOrDefault()?.SortBy;
        var newSortDescending = state.SortDefinitions.FirstOrDefault()?.Descending ?? false;

        var stateChanged = currentPage != state.Page 
            || currentPageSize != state.PageSize
            || currentSortBy != newSortBy
            || currentSortDescending != newSortDescending;

        currentPage = state.Page;
        currentPageSize = state.PageSize;
        currentSortBy = newSortBy;
        currentSortDescending = newSortDescending;

        if (stateChanged)
        {
            UpdateQueryParameters();
        }

        IncidentReportsGridVm? result = null;
        var gridData = new GridData<IncidentReportsGridItem>();

        try
        {
            result = await IncidentReportService.GetReports(request);
        }
        catch (Exception ex)
        {
            Snackbar.Add("Pobieranie danych nie powiodło się. Spróbuj ponownie później.", Severity.Error);
            Log.Error(ex, $"Error fetching incident reports: {ex.Message}");
        }

        if (result is null)
        {
            Snackbar.Add("Pobieranie danych nie powiodło się. Spróbuj ponownie później.", Severity.Warning);
            Log.Error($"Error fetching incident reports. Result is null.");
            return gridData;
        }

        gridData.Items = result.Items;
        gridData.TotalItems = result.ItemTotalCount;

        return gridData;
    }

    private Color GetChipColor(IncidentCategory category)
    {
        return category switch
        {
            IncidentCategory.Clinical => Color.Info,
            IncidentCategory.Pharmacotherapy => Color.Warning,
            IncidentCategory.Transfusion => Color.Error,
            IncidentCategory.Operational => Color.Secondary,
            _ => Color.Surface
        };
    }

    private string GetChipLabel(IncidentCategory category)
    {
        return category switch
        {
            IncidentCategory.Clinical => "Kliniczne",
            IncidentCategory.Pharmacotherapy => "Farmakoterapia",
            IncidentCategory.Transfusion => "Transfuzje",
            IncidentCategory.Operational => "Sprzęt/organizacja",
            _ => "Inne"
        };
    }
}
