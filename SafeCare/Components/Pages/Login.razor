@page "/login"
@using System.Web
@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Components.Authorization
@using SafeCare.ViewModels
@inject NavigationManager NavigationManager
@inject IAntiforgery Antiforgery
@inject IHttpContextAccessor HttpContextAccessor

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudCard Elevation="4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h4" Align="Align.Center">Logowanie</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-4">@ErrorMessage</MudAlert>
            }
            <form method="post" action="/signin">
                <AntiforgeryToken />
                <MudTextField @bind-Value="userName"
                Label="Nazwa użytkownika"
                Variant="Variant.Outlined"
                InputType="InputType.Text"
                Class="mb-4"
                ShrinkLabel
                MaxLength="256"
                Immediate="true"
                autocomplete="username" />
                <input type="hidden" name="userName" value="@HttpUtility.HtmlEncode(userName)" />

                <MudTextField @bind-Value="password"
                Label="Hasło"
                Variant="Variant.Outlined"
                InputType="InputType.Password"
                Class="mb-4"
                ShrinkLabel
                MaxLength="256"
                Immediate="true"
                autocomplete="current-password" />
                <input type="hidden" name="password" value="@password" />

                <MudItem Class="d-flex justify-start">
                    <MudCheckBox @bind-Value="rememberMe" Label="Zapamiętaj mnie" Color="Color.Primary" Class="mb-4" />
                </MudItem>
                <input type="hidden" name="rememberMe" value="@rememberMe.ToString().ToLowerInvariant()" />
                <input type="hidden" name="returnUrl" value="@HttpUtility.HtmlEncode(ReturnUrl)" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           FullWidth="true"
                           Size="Size.Large"
                           ButtonType="ButtonType.Submit">
                    Zaloguj
                </MudButton>
            </form>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private string userName = string.Empty;
    private string password = string.Empty;
    private bool rememberMe = false;

    private string? ErrorMessage { get; set; }

    [SupplyParameterFromQuery]
    public string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery(Name = "error")]
    public string? Error { get; set; }

    [CascadingParameter]
    private Task<AuthenticationState>? AuthenticationState { get; set; }

    [CascadingParameter]
    private MainLayout MainLayout { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        MainLayout.SetPath("/login");

        ErrorMessage = Error switch
        {
            "InvalidCredentials" => "Nieprawidłowa nazwa użytkownika lub hasło.",
            "LockedOut" => "Konto zostało zablokowane. Spróbuj ponownie później.",
            _ => null
        };

        if (AuthenticationState is not null)
        {
            var authState = await AuthenticationState;
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                NavigationManager.NavigateTo("/dashboard");
            }
        }
    }
}
